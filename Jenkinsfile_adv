pipeline {
    agent { label 'master' }

    environment {
        RCLONE_REMOTE = 'irp:General/releases/HD_Gen2/upp'
        DEST_FOLDER = "${env.WORKSPACE}/NewVersion"
    }

    stages {
        stage('Find Latest Firmware Folder') {
            steps {
                script {
                    // Get latest folder name
                    def latestFolder = sh(
                        script: """
                            rclone lsd "$RCLONE_REMOTE" | sort -k2,3 | tail -n1 | awk '{\$1=\$2=\$3=""; print \$0}' | sed 's/^ *//'
                        """,
                        returnStdout: true
                    ).trim()

                    echo "Latest firmware folder: ${latestFolder}"

                    // Save to env for next stage
                    env.LATEST_VERSION = latestFolder
                }
            }
        }

        stage('Copy Latest Firmware') {
            steps {
                sh """
                    echo Cleaning up old version...
                    rm -rf "${DEST_FOLDER}"
                    mkdir -p "${DEST_FOLDER}"

                    echo Copying from irp:General/releases/HD_Gen2/upp/${LATEST_VERSION}
                    rclone copy "irp:General/releases/HD_Gen2/upp/${LATEST_VERSION}" "${DEST_FOLDER}"
                """
            }
        }

        stage('End Test') {
            steps {
                sh 'echo End test from Windows agent'
            }
        }
    }
}
